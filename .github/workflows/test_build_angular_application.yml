name: Test and Build Angular Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]



jobs:
  build_test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 21.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'
        cache: maven

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Set Up Pages
      id: pages
      uses: actions/configure-pages@v3
      
    - name: Docker compose build (no run)
      run: docker compose build

    - name: Build Backend & Test 
      working-directory: backend
      run: |
        chmod +x mvnw
        ./mvnw -B clean verify -Dspring.profiles.active=test


    - name: Install and Build App Application
      working-directory: PJM-frontend-app
      run: |
        npm ci
        npm install -g @angular/cli@17.0.2 --silent
        npm run build

    - name: Upload Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: PJM-frontend-app/dist/pjm-frontend-app/browser

    - name: Upload Surefire Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: surefire-reports
        path: backend/target/surefire-reports

    - name: Docker compose down
      if: always()
      run: docker compose down -v
    
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    needs: build_test

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v3