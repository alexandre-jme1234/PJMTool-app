<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TacheController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">com.visiplus.backend.controllers</a> &gt; <span class="el_source">TacheController.java</span></div><h1>TacheController.java</h1><pre class="source lang-java linenums">package com.visiplus.backend.controllers;

import com.visiplus.backend.dto.TacheRequest;
import com.visiplus.backend.initializer.DataInitializer;
import com.visiplus.backend.models.Priorite;
import com.visiplus.backend.models.Projet;
import com.visiplus.backend.models.Tache;
import com.visiplus.backend.models.Utilisateur;
import com.visiplus.backend.responses.ApiResponse;
import com.visiplus.backend.services.PrioriteService;
import com.visiplus.backend.services.ProjetService;
import com.visiplus.backend.services.TacheService;
import com.visiplus.backend.services.UtilisateurService;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Date;
import java.util.Objects;
import java.util.Optional;

@RequestMapping(&quot;/api/tache&quot;)
@RestController
<span class="fc" id="L30">public class TacheController {</span>

<span class="fc" id="L32">    private static Logger logger = LoggerFactory.getLogger(TacheController.class);</span>

    @Autowired
    TacheService tacheService;

    @Autowired
    ProjetService projetService;

    @Autowired
    UtilisateurService utilisateurService;

    @Autowired
    PrioriteService prioriteService;

    @PostMapping(&quot;/create&quot;)
    public ResponseEntity&lt;?&gt; createTache(@RequestBody TacheRequest input) {
<span class="fc" id="L48">        Projet projet = projetService.findById(input.getProjet_id());</span>
<span class="fc" id="L49">        Utilisateur commanditaire = utilisateurService.findById(input.getCommanditaire_id());</span>
<span class="fc" id="L50">        Utilisateur destinataire = utilisateurService.findById(input.getDestinataire_id());</span>
<span class="fc" id="L51">        Tache existTache = tacheService.findByNom(input.getNom());</span>

        // VERIFY NOT RENSEIGNER
<span class="pc bpc" id="L54" title="3 of 8 branches missed.">        if (projet == null || commanditaire == null || existTache != null || destinataire == null) {</span>
<span class="fc" id="L55">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="fc" id="L56">                    .body(new ApiResponse(false, &quot;Requette de Tache erronée ou existe deja&quot;, null));</span>
        };

        // SET NEW TACHE
<span class="fc" id="L60">        Tache tache = new Tache();</span>
<span class="fc" id="L61">        tache.setNom(input.getNom());</span>
<span class="fc" id="L62">        tache.setProjet(projet);</span>
<span class="fc" id="L63">        tache.setEtat(input.getEtat());</span>
<span class="fc" id="L64">        tache.setCommanditaire(commanditaire);</span>
<span class="fc" id="L65">        tache.setDestinataire(destinataire);</span>
<span class="fc" id="L66">        tache.setDescription(input.getDescription());</span>
<span class="fc" id="L67">        tache.setDate_debut(new Date());</span>
<span class="fc" id="L68">        tache.setDate_fin(input.getDate_fin());</span>

<span class="pc bpc" id="L70" title="2 of 4 branches missed.">        if(input.getEtat() == null || input.getEtat().isEmpty()) {</span>
<span class="nc" id="L71">            tache.setEtat(&quot;TODO&quot;);</span>
        }

<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (input.getPriorite_id() != null) {</span>
<span class="fc" id="L75">            Optional&lt;Priorite&gt; priorite = prioriteService.findById((Integer) input.getPriorite_id());</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            if (priorite != null) {</span>
<span class="fc" id="L77">                tache.setPriorite(priorite.get());</span>
            } else {
<span class="nc" id="L79">                return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L80">                        .body(new ApiResponse&lt;&gt;(false, &quot;Priorité inconnue&quot;, null));</span>
            }
        }
<span class="fc" id="L83">        tacheService.create(tache);</span>

<span class="fc" id="L85">        return ResponseEntity.status(HttpStatus.OK)</span>
<span class="fc" id="L86">                .body(new ApiResponse(true, &quot;Tache bien créé dans un projet&quot;, tache));</span>
    };

    @GetMapping(&quot;/tache&quot;)
    public ResponseEntity&lt;?&gt; getTache(@RequestParam String nom) {
<span class="nc" id="L91">        Tache tache = tacheService.findByNom(nom);</span>
<span class="nc bnc" id="L92" title="All 4 branches missed.">        if (nom == null || tache == null) {</span>
<span class="nc" id="L93">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L94">                    .body(new ApiResponse(false, &quot;Tache non trouvé, veuillez renseignez vos inputs.&quot;, null));</span>
        }
        ;
<span class="nc" id="L97">        return ResponseEntity.status(HttpStatus.OK)</span>
<span class="nc" id="L98">                .body(new ApiResponse(true, &quot;Tache bien trouvé dans un projet&quot;, tache));</span>
    };

    @GetMapping(&quot;/{id}&quot;)
    public ResponseEntity&lt;?&gt; getTacheById(@RequestParam int id) {
<span class="nc" id="L103">        Optional&lt;Tache&gt; tache = tacheService.findById(id);</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (tache == null) {</span>
<span class="nc" id="L106">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L107">                    .body(new ApiResponse(false, &quot;Tache non trouvé, veuillez renseignez vos inputs.&quot;, null));</span>
        }
        ;

<span class="nc" id="L111">        return ResponseEntity.status(HttpStatus.OK)</span>
<span class="nc" id="L112">                .body(new ApiResponse(true, &quot;Tache bien trouvé dans un projet&quot;, tache));</span>
    };

    @GetMapping(&quot;/project/{id}&quot;)
    public ResponseEntity&lt;?&gt; getTachesByProjectId(@PathVariable int id) {
<span class="fc" id="L117">        List&lt;Tache&gt; taches = tacheService.findByProjetId(id);</span>
<span class="fc" id="L118">        return ResponseEntity.ok(new ApiResponse&lt;&gt;(true, &quot;Tâches du projet&quot;, taches));</span>
    }

    @PatchMapping(&quot;/update&quot;)
    public ResponseEntity&lt;?&gt; patchTacheById(@RequestBody TacheRequest input) {
<span class="fc" id="L123">        Optional&lt;Tache&gt; existTacheOpt = tacheService.findById(input.getId());</span>

        
<span class="fc" id="L126">        Tache updateTache = new Tache();</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        if (existTacheOpt.isEmpty()) {</span>
<span class="nc" id="L128">            return ResponseEntity.status(HttpStatus.BAD_REQUEST)</span>
<span class="nc" id="L129">                    .body(new ApiResponse(false, &quot;Tache non reconnu ou n'existe pas&quot;, null));</span>
        }

<span class="fc" id="L132">        Tache existTache = existTacheOpt.get();</span>
        try {
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">            if (input.getCommanditaire_id() != null) {</span>
<span class="nc" id="L135">                Utilisateur commanditaire = utilisateurService.findById(input.getCommanditaire_id());</span>
<span class="nc" id="L136">                existTache.setCommanditaire(commanditaire);</span>
            }

<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (input.getDestinataire_id() != null) {</span>
<span class="nc" id="L140">                Utilisateur destinataire = utilisateurService.findById(input.getDestinataire_id());</span>
<span class="nc" id="L141">                existTache.setDestinataire(destinataire);</span>
            }

<span class="pc bpc" id="L144" title="1 of 2 branches missed.">            if (input.getProjet_id() != null) {</span>
<span class="nc" id="L145">                Projet projet = projetService.findById(input.getProjet_id());</span>
<span class="nc" id="L146">                existTache.setProjet(projet);</span>
            }

<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            if (input.getNom() != null) {</span>
<span class="nc" id="L150">                existTache.setNom(input.getNom());</span>
            }

<span class="pc bpc" id="L153" title="1 of 2 branches missed.">            if (input.getDate_debut() != null) {</span>
<span class="nc" id="L154">                existTache.setDate_debut(input.getDate_debut());</span>
            }

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (input.getDate_fin() != null) {</span>
<span class="nc" id="L158">                existTache.setDate_fin(input.getDate_fin());</span>
            }

<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            if (input.getEtat() != null) {</span>
<span class="fc" id="L162">                existTache.setEtat(input.getEtat());</span>
            }

<span class="pc bpc" id="L165" title="1 of 2 branches missed.">            if (input.getDescription() != null) {</span>
<span class="fc" id="L166">                existTache.setDescription(input.getDescription());</span>
            }

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">            if (input.getPriorite_id() != null) {</span>

                Priorite priorite;

<span class="nc bnc" id="L173" title="All 2 branches missed.">                if (input.getPriorite_id() instanceof Integer) {</span>
<span class="nc" id="L174">                    Integer priorite_id = input.getPriorite_id();</span>
<span class="nc" id="L175">                    Optional&lt;Priorite&gt; priorite_exist = prioriteService.findById(priorite_id);</span>
<span class="nc" id="L176">                    existTache.setPriorite(priorite_exist.get());</span>
<span class="nc" id="L177">                } else {</span>
<span class="nc" id="L178">                    Optional&lt;Priorite&gt; priorite_exist = prioriteService.findById(102);</span>
<span class="nc" id="L179">                    existTache.setPriorite(priorite_exist.get());</span>
                }

            }

<span class="fc" id="L184">            Tache updatedTache = tacheService.save(existTache);</span>
<span class="fc" id="L185">            return ResponseEntity.status(HttpStatus.OK)</span>
<span class="fc" id="L186">                    .body(new ApiResponse&lt;&gt;(true, &quot;Tache bien mise à jour&quot;, updatedTache));</span>

<span class="nc" id="L188">        } catch (Exception e) {</span>
<span class="nc" id="L189">            e.printStackTrace();</span>
<span class="nc" id="L190">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L191">                    .body(new ApiResponse&lt;&gt;(false, &quot;Erreur lors de la mise à jour&quot;, e.getMessage()));</span>
        }
    };

    @PutMapping(&quot;/update&quot;)
    public ResponseEntity&lt;?&gt; updateTacheById(@RequestBody TacheRequest input) {
<span class="nc" id="L197">        return patchTacheById(input);</span>
    }

    @DeleteMapping(&quot;/delete/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteTacheById(@PathVariable int id ){
<span class="fc" id="L202">        Optional&lt;Tache&gt; tache = tacheService.findById(id);</span>
        
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if(tache.isEmpty()){</span>
<span class="nc" id="L205">            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(new ApiResponse&lt;&gt;(false, &quot;Tache n'existe pas&quot;, null));</span>
        }
        
<span class="fc" id="L208">        boolean deleted = tacheService.deleteByID(id);</span>

<span class="fc" id="L210">        return ResponseEntity</span>
<span class="fc" id="L211">                .status(HttpStatus.OK)</span>
<span class="fc" id="L212">                .body(new ApiResponse&lt;&gt;(true, &quot;Tache a été trouvé&quot;, deleted));</span>
    }
};
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>